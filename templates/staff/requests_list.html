{% extends 'base.html' %}

{% block title %}Mes Requ√™tes{% endblock %}

{% block content %}
<div class="container">
    <div class="flex flex-between items-center mb-3">
        <h1>üìã Requ√™tes assign√©es</h1>
        <a href="/staff/dashboard/" class="btn btn-secondary">‚Üê Dashboard</a>
    </div>

    <!-- Filters -->
    <div class="card mb-2">
        <form method="get" class="flex gap-2 items-center flex-wrap">
            <div class="form-group" style="margin: 0; flex: 1; min-width: 150px;">
                <select name="status" class="form-control form-select" onchange="this.form.submit()">
                    <option value="">Tous les statuts</option>
                    <option value="sent" {% if status_filter == 'sent' %}selected{% endif %}>Envoy√©e</option>
                    <option value="received" {% if status_filter == 'received' %}selected{% endif %}>Re√ßue</option>
                    <option value="approved" {% if status_filter == 'approved' %}selected{% endif %}>Approuv√©e</option>
                    <option value="rejected" {% if status_filter == 'rejected' %}selected{% endif %}>Rejet√©e</option>
                    <option value="in_cellule" {% if status_filter == 'in_cellule' %}selected{% endif %}>En cellule</option>
                    <option value="returned" {% if status_filter == 'returned' %}selected{% endif %}>Retourn√©e</option>
                    <option value="done" {% if status_filter == 'done' %}selected{% endif %}>Termin√©e</option>
                </select>
            </div>
            <div class="form-group" style="margin: 0; flex: 1; min-width: 150px;">
                <select name="type" class="form-control form-select" onchange="this.form.submit()">
                    <option value="">Tous les types</option>
                    <option value="cc" {% if type_filter == 'cc' %}selected{% endif %}>CC</option>
                    <option value="exam" {% if type_filter == 'exam' %}selected{% endif %}>EXAM</option>
                </select>
            </div>
            <div class="form-group" style="margin: 0; flex: 1; min-width: 150px;">
                <select name="subject" class="form-control form-select" onchange="this.form.submit()">
                    <option value="">Toutes les mati√®res</option>
                    {% for subject in subjects %}
                    <option value="{{ subject.id }}" {% if subject_filter == subject.id|stringformat:"s" %}selected{% endif %}>
                        {{ subject.name }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group" style="margin: 0; flex: 1; min-width: 150px;">
                <select name="class" class="form-control form-select" onchange="this.form.submit()">
                    <option value="">Tous les niveaux</option>
                    {% for class_level in class_levels %}
                    <option value="{{ class_level.id }}" {% if class_filter == class_level.id|stringformat:"s" %}selected{% endif %}>
                        {{ class_level.name }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <button type="submit" class="btn btn-outline">Filtrer</button>
            <a href="/staff/requests/" class="btn btn-secondary">R√©initialiser</a>
        </form>
    </div>

    <!-- Requests Table -->
    <div class="card">
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>√âtudiant</th>
                        <th>Niveau</th>
                        <th>Mati√®re</th>
                        <th>Type</th>
                        <th>Statut</th>
                        <th>Date</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for req in requests_list %}
                    <tr class="clickable" onclick="window.location='/staff/requests/{{ req.id }}/'">
                        <td>
                            <strong>{{ req.student_name }}</strong>
                            <br>
                            <small style="color: var(--text-secondary);">{{ req.matricule }}</small>
                        </td>
                        <td>{{ req.class_level.name }}</td>
                        <td>{{ req.subject.name }}</td>
                        <td>{{ req.get_type_display }}</td>
                        <td><span class="badge badge-{{ req.status }}">{{ req.get_status_display }}</span></td>
                        <td>{{ req.submitted_at|date:"d/m/Y H:i" }}</td>
                        <td onclick="event.stopPropagation();">
                            <a href="/staff/requests/{{ req.id }}/" class="btn btn-sm btn-primary">Voir d√©tails</a>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="7" class="text-center" style="padding: 3rem; color: var(--text-secondary);">
                            <div style="font-size: 3rem; margin-bottom: 1rem;">üì≠</div>
                            <h3>Aucune requ√™te trouv√©e</h3>
                            <p>Aucune requ√™te ne correspond √† vos crit√®res de recherche.</p>
                            <a href="/staff/requests/" class="btn btn-secondary mt-1">R√©initialiser les filtres</a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        {% if requests_list %}
        <div class="card-footer">
            <p style="margin: 0; color: var(--text-secondary);">
                Total: <strong>{{ requests_list.count }}</strong> requ√™te(s)
            </p>
        </div>
        {% endif %}
    </div>

    <!-- Legend -->
    <div class="card mt-2">
        <div class="card-header">
            <h4 style="margin: 0; font-size: 1rem;">üìñ L√©gende des statuts</h4>
        </div>
        <div style="padding: 1rem; display: flex; flex-wrap: wrap; gap: 1rem;">
            <div style="display: flex; align-items: center; gap: 0.5rem;">
                <span class="badge badge-sent">Envoy√©e</span>
                <span style="color: var(--text-secondary); font-size: 0.875rem;">Nouvelle requ√™te</span>
            </div>
            <div style="display: flex; align-items: center; gap: 0.5rem;">
                <span class="badge badge-received">Re√ßue</span>
                <span style="color: var(--text-secondary); font-size: 0.875rem;">Accus√© r√©ception</span>
            </div>
            <div style="display: flex; align-items: center; gap: 0.5rem;">
                <span class="badge badge-approved">Approuv√©e</span>
                <span style="color: var(--text-secondary); font-size: 0.875rem;">Demande accept√©e</span>
            </div>
            <div style="display: flex; align-items: center; gap: 0.5rem;">
                <span class="badge badge-rejected">Rejet√©e</span>
                <span style="color: var(--text-secondary); font-size: 0.875rem;">Demande refus√©e</span>
            </div>
            <div style="display: flex; align-items: center; gap: 0.5rem;">
                <span class="badge badge-in_cellule">En cellule</span>
                <span style="color: var(--text-secondary); font-size: 0.875rem;">Traitement informatique</span>
            </div>
            <div style="display: flex; align-items: center; gap: 0.5rem;">
                <span class="badge badge-returned">Retourn√©e</span>
                <span style="color: var(--text-secondary); font-size: 0.875rem;">Retour au responsable</span>
            </div>
            <div style="display: flex; align-items: center; gap: 0.5rem;">
                <span class="badge badge-done">Termin√©e</span>
                <span style="color: var(--text-secondary); font-size: 0.875rem;">Traitement complet</span>
            </div>
        </div>
    </div>
</div>
{% endblock %}
