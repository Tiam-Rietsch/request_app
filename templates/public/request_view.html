{% extends 'base.html' %}

{% block title %}RequÃªte #{{ request_obj.id|truncatechars:8 }}{% endblock %}

{% block content %}
<div class="container" style="max-width: 900px;">
    <div class="text-center mb-3">
        <h1>ğŸ“‹ Vue publique de la requÃªte</h1>
        <p style="color: var(--text-secondary);">
            Informations accessibles via code QR
        </p>
    </div>

    <!-- Progress Map -->
    {% include 'requests/progress_map.html' with request=request_obj %}

    <!-- Request Status Card -->
    <div class="card mb-2">
        <div class="card-header text-center">
            <h3 class="card-title" style="margin: 0;">Statut actuel</h3>
        </div>
        <div style="padding: 2rem; text-align: center;">
            <div style="font-size: 3rem; margin-bottom: 1rem;">
                {% if request_obj.status == 'sent' %}ğŸ“¤
                {% elif request_obj.status == 'received' %}ğŸ“¥
                {% elif request_obj.status == 'approved' %}âœ…
                {% elif request_obj.status == 'rejected' %}âŒ
                {% elif request_obj.status == 'in_cellule' %}ğŸ’»
                {% elif request_obj.status == 'returned' %}â†©ï¸
                {% elif request_obj.status == 'done' %}ğŸ‰
                {% endif %}
            </div>
            <h2 style="margin: 0 0 0.5rem 0;">
                <span class="badge badge-{{ request_obj.status }}" style="font-size: 1.25rem; padding: 0.75rem 1.5rem;">
                    {{ request_obj.get_status_display }}
                </span>
            </h2>
            <p style="color: var(--text-secondary); margin: 1rem 0 0 0;">
                DerniÃ¨re mise Ã  jour: {{ request_obj.submitted_at|date:"d/m/Y Ã  H:i" }}
            </p>
        </div>
    </div>

    <!-- Request Information -->
    <div class="card mb-2">
        <div class="card-header">
            <h3 class="card-title">Informations de la requÃªte</h3>
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; padding: 1.5rem;">
            <div>
                <div style="margin-bottom: 1rem;">
                    <strong style="color: var(--text-secondary); font-size: 0.875rem;">ID de la requÃªte</strong>
                    <p style="margin: 0.25rem 0 0 0; font-family: monospace; font-size: 0.875rem; color: var(--primary);">
                        {{ request_obj.id }}
                    </p>
                </div>
                <div style="margin-bottom: 1rem;">
                    <strong style="color: var(--text-secondary); font-size: 0.875rem;">Ã‰tudiant</strong>
                    <p style="margin: 0.25rem 0 0 0; font-size: 1.125rem;">{{ request_obj.student_name }}</p>
                </div>
                <div style="margin-bottom: 1rem;">
                    <strong style="color: var(--text-secondary); font-size: 0.875rem;">Matricule</strong>
                    <p style="margin: 0.25rem 0 0 0;">{{ request_obj.matricule }}</p>
                </div>
            </div>
            <div>
                <div style="margin-bottom: 1rem;">
                    <strong style="color: var(--text-secondary); font-size: 0.875rem;">MatiÃ¨re</strong>
                    <p style="margin: 0.25rem 0 0 0; font-size: 1.125rem; color: var(--primary);">{{ request_obj.subject.name }}</p>
                </div>
                <div style="margin-bottom: 1rem;">
                    <strong style="color: var(--text-secondary); font-size: 0.875rem;">Type de requÃªte</strong>
                    <p style="margin: 0.25rem 0 0 0;">{{ request_obj.get_type_display }}</p>
                </div>
                <div>
                    <strong style="color: var(--text-secondary); font-size: 0.875rem;">Date de soumission</strong>
                    <p style="margin: 0.25rem 0 0 0;">{{ request_obj.submitted_at|date:"d/m/Y Ã  H:i" }}</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Description -->
    <div class="card mb-2">
        <div class="card-header">
            <h3 class="card-title">Description de la demande</h3>
        </div>
        <div style="padding: 1.5rem;">
            <p style="margin: 0; line-height: 1.6; white-space: pre-wrap;">{{ request_obj.description }}</p>
        </div>
    </div>

    <!-- Result (if done or rejected) -->
    {% if request_obj.result %}
    <div class="card mb-2">
        <div class="card-header">
            <h3 class="card-title">ğŸ¯ RÃ©sultat final</h3>
        </div>
        <div style="padding: 1.5rem;">
            <div style="margin-bottom: 1rem;">
                <strong style="color: var(--text-secondary); font-size: 0.875rem;">DÃ©cision</strong>
                <p style="margin: 0.25rem 0 0 0;">
                    <span class="badge badge-{{ request_obj.result.status }}" style="font-size: 1rem; padding: 0.5rem 1rem;">
                        {{ request_obj.result.get_status_display }}
                    </span>
                </p>
            </div>

            {% if request_obj.result.new_score %}
            <div style="margin-bottom: 1rem;">
                <strong style="color: var(--text-secondary); font-size: 0.875rem;">Nouvelle note</strong>
                <p style="margin: 0.25rem 0 0 0; font-size: 1.5rem; color: var(--success); font-weight: 600;">
                    {{ request_obj.result.new_score }}/20
                </p>
            </div>
            {% endif %}

            {% if request_obj.result.reason %}
            <div style="margin-bottom: 1rem;">
                <strong style="color: var(--text-secondary); font-size: 0.875rem;">Commentaire</strong>
                <p style="margin: 0.25rem 0 0 0; padding: 1rem; background: var(--background); border-radius: 4px; line-height: 1.6;">
                    {{ request_obj.result.reason }}
                </p>
            </div>
            {% endif %}

            <div>
                <strong style="color: var(--text-secondary); font-size: 0.875rem;">Date de finalisation</strong>
                <p style="margin: 0.25rem 0 0 0;">
                    {{ request_obj.result.created_at|date:"d/m/Y Ã  H:i" }}
                </p>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Info Box -->
    <div class="card">
        <div style="padding: 1.5rem; text-align: center; background: var(--background);">
            <p style="margin: 0; color: var(--text-secondary); line-height: 1.6;">
                <strong>â„¹ï¸ Information:</strong><br>
                Cette page est accessible publiquement via le code QR de la requÃªte.<br>
                Pour plus de fonctionnalitÃ©s, veuillez vous connecter Ã  votre compte.
            </p>
            <div style="margin-top: 1.5rem; display: flex; gap: 1rem; justify-content: center;">
                <a href="{% url 'login' %}" class="btn btn-primary">Se connecter</a>
                <button onclick="window.print()" class="btn btn-outline">ğŸ–¨ï¸ Imprimer</button>
            </div>
        </div>
    </div>

    <!-- Print-only header -->
    <div class="print-only" style="display: none;">
        <div style="text-align: center; margin-bottom: 2rem; padding-bottom: 1rem; border-bottom: 2px solid var(--border);">
            <h1 style="margin: 0 0 0.5rem 0; color: var(--primary);">SystÃ¨me de Gestion des RequÃªtes</h1>
            <p style="margin: 0; color: var(--text-secondary);">RequÃªte #{{ request_obj.id }}</p>
            <p style="margin: 0.5rem 0 0 0; font-size: 0.875rem; color: var(--text-secondary);">
                ImprimÃ© le {{ "now"|date:"d/m/Y Ã  H:i" }}
            </p>
        </div>
    </div>
</div>

<style>
    @media print {
        .print-only {
            display: block !important;
        }
    }
</style>
{% endblock %}
